// Erosko.cz - Escort Portal Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum ProfileType {
  SOLO           // Independent escort
  PRIVAT         // Private location (Erotický privát)
  MASSAGE_SALON  // Massage salon (Erotické masáže)
  ESCORT_AGENCY  // Escort agency (Escort Agentura)
  DIGITAL_AGENCY // Online services (Digitální Agentura)
  SWINGERS_CLUB  // Swingers club (Swingers klub)
  NIGHT_CLUB     // Night club (Night Club)
  STRIP_CLUB     // Strip club (Strip Club)
}

enum Category {
  HOLKY_NA_SEX      // Girls for sex
  EROTICKE_MASERKY  // Erotic masseuses
  DOMINA            // BDSM/Domina
  DIGITALNI_SLUZBY  // Digital services (webcam, phone sex, etc.)
  EROTICKE_PODNIKY  // Erotic businesses (clubs, etc.)
}

enum UserRole {
  USER
  PROVIDER
  ADMIN
}

// Models
model User {
  id            String   @id @default(cuid())
  phone         String   @unique  // Primary login method
  email         String?  // Optional for notifications
  passwordHash  String
  phoneVerified Boolean  @default(false)
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  profiles           Profile[]
  businesses         Business[]
  reviews            Review[]
  favorites          Favorite[]
  requestedChanges   PendingChange[] @relation("RequestedChanges")
  reviewedChanges    PendingChange[] @relation("ReviewedChanges")
  verificationCodes  VerificationCode[]

  @@index([phone])
}

// SMS Verification codes for password reset and phone verification
model VerificationCode {
  id          String   @id @default(cuid())
  phone       String
  code        String   // 6-digit code
  type        VerificationCodeType
  expiresAt   DateTime
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([code])
}

enum VerificationCodeType {
  PHONE_VERIFICATION
  PASSWORD_RESET
}

model Business {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  phone       String
  email       String?
  website     String?
  address     String?
  city        String
  profileType ProfileType

  // Business-specific fields
  equipment   Json?       // Array of equipment/amenities
  openingHours Json?      // Opening hours by day: { monday: "9:00-22:00", ... }

  // Metadata
  approved    Boolean     @default(false)  // Admin approved for public display
  verified    Boolean     @default(false)  // Admin verified with badge
  isNew       Boolean     @default(true)
  isPopular   Boolean     @default(false)

  // Stats
  rating      Float       @default(0)
  reviewCount Int         @default(0)
  viewCount   Int         @default(0)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  ownerId     String
  owner       User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  profiles       Profile[]
  photos         Photo[]
  reviews        Review[]
  pendingChanges PendingChange[]

  @@index([city])
  @@index([profileType])
  @@index([slug])
}

model Profile {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  age         Int
  description String?
  phone       String
  email       String?

  // Location
  city        String
  address     String?
  location    String      // Display location

  // Profile type
  profileType ProfileType
  category    Category

  // Physical attributes
  height      Int?        // cm
  weight      Int?        // kg
  bust        String?     // 1, 2, 3, 4
  hairColor   String?     // blonde, brunette, black, red, other
  breastType  String?     // natural, silicone

  // Additional attributes
  role        String?     // active, passive, switch, dominant, submissive
  nationality String?     // czech, slovak, polish, ukrainian, russian, etc.
  languages   String?     // JSON array of languages
  orientation String?     // hetero, bi, lesbian, gay
  tattoos     String?     // none, small, medium, large
  piercing    String?     // none, ears, multiple

  // Services
  offersEscort Boolean    @default(false)
  travels     Boolean    @default(false)

  // Opening hours (for individual profiles)
  openingHours Json?      // Opening hours by day: { monday: "9:00-22:00", ... }

  // Metadata
  approved    Boolean    @default(false)  // Admin approved for public display
  verified    Boolean    @default(false)  // Admin verified with badge
  isNew       Boolean    @default(true)
  isPopular   Boolean    @default(false)
  isOnline    Boolean    @default(false)

  // Stats
  rating      Float      @default(0)
  reviewCount Int        @default(0)
  viewCount   Int        @default(0)

  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  ownerId     String
  owner       User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  businessId  String?
  business    Business?  @relation(fields: [businessId], references: [id], onDelete: SetNull)
  photos         Photo[]
  reviews        Review[]
  services       ProfileService[]
  favorites      Favorite[]
  pendingChanges PendingChange[]

  @@index([city])
  @@index([category])
  @@index([profileType])
  @@index([slug])
}

model Photo {
  id          String    @id @default(cuid())
  url         String
  alt         String?
  order       Int       @default(0)
  isMain      Boolean   @default(false)

  // Relations
  profileId   String?
  profile     Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId  String?
  business    Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@index([profileId])
  @@index([businessId])
}

model Service {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?  // Icon name from lucide-react

  // Relations
  profiles    ProfileService[]
}

model ProfileService {
  id        String   @id @default(cuid())

  // Relations
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([profileId, serviceId])
  @@index([profileId])
  @@index([serviceId])
}

model Review {
  id          String   @id @default(cuid())
  rating      Int      // 1-5
  comment     String?
  // Relations
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  profileId   String?
  profile     Profile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId  String?
  business    Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([profileId])
  @@index([businessId])
  @@index([authorId])
}

model Favorite {
  id        String   @id @default(cuid())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, profileId])
  @@index([userId])
  @@index([profileId])
}

enum ChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ChangeType {
  PROFILE_UPDATE
  PHOTO_UPDATE
  BUSINESS_UPDATE
}

model PendingChange {
  id          String       @id @default(cuid())
  type        ChangeType
  status      ChangeStatus @default(PENDING)

  // Reference to what's being changed
  profileId   String?
  profile     Profile?     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId  String?
  business    Business?    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Change data
  oldData     Json?        // Original data
  newData     Json         // Requested changes

  // Who requested the change
  requestedById String
  requestedBy   User       @relation("RequestedChanges", fields: [requestedById], references: [id], onDelete: Cascade)

  // Who approved/rejected
  reviewedById  String?
  reviewedBy    User?      @relation("ReviewedChanges", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([profileId])
  @@index([businessId])
  @@index([status])
  @@index([requestedById])
}
